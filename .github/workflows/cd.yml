name: Deploy to GKE

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GKE_ZONE: ${{ secrets.GKE_ZONE }}
  DEPLOYMENT_NAME: devops-app
  IMAGE: devops-app-gcp
  NAMESPACE: devops-app
  REGION: us-central1
  USE_GKE_GCLOUD_AUTH_PLUGIN: "True"

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER }} \
            --zone=${{ secrets.GKE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }}

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/devops-app-gcp/${{ env.IMAGE }}:${{ github.sha }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/devops-app-gcp/${{ env.IMAGE }}:latest \
            .

      - name: Push Docker image
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/devops-app-gcp/${{ env.IMAGE }}:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/devops-app-gcp/${{ env.IMAGE }}:latest

      - name: Deploy to GKE
        run: |
          kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} \
            ${{ env.DEPLOYMENT_NAME }}=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/devops-app-gcp/${{ env.IMAGE }}:${{ github.sha }} \
            -n ${{ env.NAMESPACE }}
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} \
            -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.DEPLOYMENT_NAME }}

      - name: Run smoke tests
        run: |
          EXTERNAL_IP=$(kubectl get service devops-app-service -n ${{ env.NAMESPACE }} \
            -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          
          for i in {1..30}; do
            if [ ! -z "$EXTERNAL_IP" ]; then
              break
            fi
            echo "Aguardando IP externo... ($i/30)"
            sleep 10
            EXTERNAL_IP=$(kubectl get service devops-app-service -n ${{ env.NAMESPACE }} \
              -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          done
          
          if [ -z "$EXTERNAL_IP" ]; then
            echo "ERRO: IP externo não foi atribuído"
            exit 1
          fi
          
          curl -f --max-time 10 http://$EXTERNAL_IP/health
          curl -f --max-time 10 http://$EXTERNAL_IP/api/info
          echo "Deploy realizado com sucesso!"